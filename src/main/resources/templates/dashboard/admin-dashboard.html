<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link rel="stylesheet" href="/css/admin-dashboard.css">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div th:fragment="content">
        <div class="container-fluid dashboard-content">
            <!-- Toggle Buttons -->
            <div class="row mb-4">
                <div class="col-3"></div>
                <div class="col-6 text-center">
                    <div class="btn-group" role="group">
                        <input type="radio" class="btn-check" name="viewType" id="usersView" checked>
                        <label class="btn btn-outline-primary" for="usersView">
                            <i class="fas fa-users"></i> Users
                        </label>
                        
                        <input type="radio" class="btn-check" name="viewType" id="propertiesView">
                        <label class="btn btn-outline-primary" for="propertiesView">
                            <i class="fas fa-home"></i> Properties
                        </label>

                        <input type="radio" class="btn-check" name="viewType" id="reportsView">
                        <label class="btn btn-outline-primary" for="reportsView">
                            <i class="fas fa-flag"></i> Reports
                        </label>
                    </div>
                </div>
                <div class="col-3"></div>
            </div>

            <div class="row">
                <!-- Left Sidebar with Filters -->
                <div class="col-xl-3">
                    <div class="filter-card">
                        <div class="filter-header">
                            <h4><i class="fas fa-filter"></i> Filters</h4>
                        </div>
                        
                        <!-- Users Filter Section -->
                        <div class="filter-section" id="usersFilterSection">
                            <h5 class="filter-title">Verification Status</h5>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="VERIFIED" id="statusVerified" checked>
                                <label class="form-check-label status-label verified" for="statusVerified">
                                    <i class="fas fa-check-circle"></i> Verified
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="UNVERIFIED" id="statusUnverified" checked>
                                <label class="form-check-label status-label unverified" for="statusUnverified">
                                    <i class="fas fa-times-circle"></i> Unverified
                                </label>
                            </div>

                            <h5 class="filter-title mt-4">User Type</h5>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="LANDLORD" id="typeLandlord" checked>
                                <label class="form-check-label" for="typeLandlord">
                                    <i class="fas fa-user-tie"></i> Landlord
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="TENANT" id="typeTenant" checked>
                                <label class="form-check-label" for="typeTenant">
                                    <i class="fas fa-user"></i> Tenant
                                </label>
                            </div>

                            <!-- User Search -->
                            <div class="filter-section">
                                <h5 class="filter-title">Search User</h5>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="userSearch" placeholder="Enter username...">
                                    <button class="btn btn-outline-primary" type="button" id="searchUserBtn">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Properties Filter Section -->
                        <div class="filter-section" id="propertiesFilterSection">
                            <h5 class="filter-title">Property Status</h5>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="true" id="statusRented" checked>
                                <label class="form-check-label status-label rented" for="statusRented">
                                    Rented
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="false" id="statusUnrented" checked>
                                <label class="form-check-label status-label unrented" for="statusUnrented">
                                    Not Rented
                                </label>
                            </div>

                            <!-- Owner Search -->
                            <div class="mt-4">
                                <h5 class="filter-title">Search by Owner</h5>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="ownerSearch" placeholder="Enter owner username...">
                                </div>
                            </div>
                        </div>

                        <!-- Reports Filter Section -->
                        <div class="filter-section" id="reportsFilterSection" style="display: none;">
                            <h5 class="filter-title">Report Status</h5>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="resolvedFilter" checked>
                                <label class="form-check-label" for="resolvedFilter">Resolved</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="unresolvedFilter" checked>
                                <label class="form-check-label" for="unresolvedFilter">Unresolved</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Content Area -->
                <div class="col-xl-9">
                    <div class="content-card">
                        <div class="content-header">
                            <h2><i class="fas fa-shield-alt"></i> Admin Dashboard</h2>
                        </div>
                        <div id="dashboardContent">
                            <div id="usersTable">
                                <div class="table-responsive mt-3">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Username</th>
                                                <th>Full Name</th>
                                                <th>Email</th>
                                                <th>Role & Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="usersTableBody">
                                            <!-- User data will be dynamically inserted here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div id="propertiesTable" style="display: none;">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Location</th>
                                                <th>Owner</th>
                                                <th>Type</th>
                                                <th>Price</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="propertiesTableBody">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div id="reportsContent" style="display: none;">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-striped">
                                                <thead>
                                                    <tr>
                                                        <th>ID</th>
                                                        <th>User ID</th>
                                                        <th>User Role</th>
                                                        <th>Title</th>
                                                        <th>Created At</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="reportsTableBody">
                                                    <!-- Reports will be populated here -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Details Modal -->
    <div class="modal fade" id="reportDetailsModal" tabindex="-1" aria-labelledby="reportDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reportDetailsModalLabel">Report Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <strong>Title:</strong>
                        <div id="reportTitle" class="mt-1"></div>
                    </div>
                    <div class="mb-3">
                        <strong>Description:</strong>
                        <div id="reportDescription" class="mt-1"></div>
                    </div>
                    <div class="mb-3">
                        <strong>Reported By:</strong>
                        <div id="reportUser" class="mt-1"></div>
                    </div>
                    <div class="mb-3">
                        <strong>User Role:</strong>
                        <div id="reportUserRole" class="mt-1"></div>
                    </div>
                    <div class="mb-3">
                        <strong>Date Submitted:</strong>
                        <div id="reportDate" class="mt-1"></div>
                    </div>
                    <div class="mb-3">
                        <strong>Status:</strong>
                        <div id="reportStatus" class="mt-1"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts Fragment -->
    <th:block th:fragment="scripts">
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <style>
            .btn.btn-outline-primary.hover-primary:hover {
                color: #fff;
                background-color: var(--bs-primary);
                border-color: var(--bs-primary);
            }
            .status-label.verified {
                color: #28a745;
            }
            .status-label.unverified {
                color: #dc3545;
            }
            .table {
                margin-bottom: 0;
            }
            
            .table th {
                background-color: #f8f9fa;
                border-bottom: 2px solid #dee2e6;
                font-weight: 600;
            }
            
            .table td {
                vertical-align: middle;
                padding: 0.75rem;
            }
            
            .badge {
                font-size: 0.85em;
                padding: 0.5em 0.75em;
                text-transform: lowercase;
            }

            .badge::first-letter {
                text-transform: uppercase;
            }
            
            .btn-sm {
                padding: 0.25rem 0.5rem;
            }
            
            .content-card {
                background: #fff;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                padding: 1.5rem;
                margin-bottom: 2rem;
            }
            
            .table-responsive {
                border-radius: 8px;
                overflow: hidden;
            }
            
            .table tbody tr:hover {
                background-color: rgba(0,0,0,0.02);
            }
            
            .rental-confirmation {
                text-align: center;
                padding: 20px;
            }
            .rental-confirmation .title {
                color: #2c3e50;
                font-size: 1.5em;
                margin-bottom: 20px;
            }
            .rental-confirmation .info {
                background: #f8f9fa;
                border: 2px solid #28a745;
                border-radius: 8px;
                padding: 15px;
                margin: 15px 0;
            }
            .rental-confirmation .info:hover {
                background: #e9ecef;
            }
            .filter-card {
                background-color: #fff;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                padding: 1.5rem;
                margin-bottom: 2rem;
            }
            .filter-header {
                margin-bottom: 1rem;
            }
            .filter-section {
                margin-bottom: 2rem;
            }
            .filter-title {
                margin-bottom: 0.5rem;
            }
            .status-label.rented {
                color: #28a745;
            }
            .status-label.unrented {
                color: #dc3545;
            }
        </style>
        <script th:inline="javascript">
            function updateDashboard() {
                const view = document.querySelector('input[name="viewType"]:checked').id;
                
                // Hide all filter sections and content
                document.getElementById('usersFilterSection').style.display = 'none';
                document.getElementById('propertiesFilterSection').style.display = 'none';
                document.getElementById('reportsFilterSection').style.display = 'none';
                document.getElementById('usersTable').style.display = 'none';
                document.getElementById('propertiesTable').style.display = 'none';
                document.getElementById('reportsContent').style.display = 'none';

                if (view === 'usersView') {
                    document.getElementById('usersFilterSection').style.display = 'block';
                    document.getElementById('usersTable').style.display = 'block';
                    fetchUsers();
                } else if (view === 'propertiesView') {
                    document.getElementById('propertiesFilterSection').style.display = 'block';
                    document.getElementById('propertiesTable').style.display = 'block';
                    fetchProperties();
                } else if (view === 'reportsView') {
                    document.getElementById('reportsFilterSection').style.display = 'block';
                    document.getElementById('reportsContent').style.display = 'block';
                    loadReports();
                }
            }

            function fetchUsers() {
                console.log('Fetching users...');
                const tableBody = document.getElementById('usersTableBody');
                
                // Get filter values
                const username = document.getElementById('userSearch').value;
                const verifiedChecked = document.getElementById('statusVerified').checked;
                const unverifiedChecked = document.getElementById('statusUnverified').checked;
                const landlordChecked = document.getElementById('typeLandlord').checked;
                const tenantChecked = document.getElementById('typeTenant').checked;
                
                // Show loading state
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </td>
                    </tr>
                `;

                // Build query parameters
                const params = new URLSearchParams();
                if (username) params.append('username', username);
                
                // Handle role filter
                if (landlordChecked && !tenantChecked) {
                    params.append('role', 'LANDLORD');
                } else if (tenantChecked && !landlordChecked) {
                    params.append('role', 'TENANT');
                }
                
                // Handle verification filter
                if (verifiedChecked && !unverifiedChecked) {
                    params.append('verified', true);
                } else if (unverifiedChecked && !verifiedChecked) {
                    params.append('verified', false);
                }
                
                fetch(`/api/administrators/users?${params.toString()}`)
                    .then(response => response.json())
                    .then(users => {
                        console.log('Received users:', users);
                        tableBody.innerHTML = '';
                        
                        users.forEach(user => {
                            const roleValue = user.roles && user.roles[0] ? user.roles[0] : '';
                            const verifiedStatus = user.verified ? 
                                '<span class="badge bg-success"><i class="fas fa-check-circle"></i> Verified</span>' : 
                                '<span class="badge bg-warning"><i class="fas fa-clock"></i> Pending</span>';
                            
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${user.id || ''}</td>
                                <td>${user.username || ''}</td>
                                <td>${user.firstName || ''} ${user.lastName || ''}</td>
                                <td>${user.email || ''}</td>
                                <td>
                                    <span class="badge ${getBadgeClass(roleValue)}">${roleValue}</span>
                                    ${verifiedStatus}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewUser(${user.id})" title="View User">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    ${roleValue !== 'ADMINISTRATOR' ? 
                                        `<button class="btn btn-sm btn-outline-danger ms-1" onclick="deleteUser(${user.id})" title="Delete User">
                                            <i class="fas fa-trash"></i>
                                        </button>` : ''
                                    }
                                    ${!user.verified && (roleValue === 'TENANT' || roleValue === 'LANDLORD') ? 
                                        `<button class="btn btn-sm btn-outline-success ms-1" onclick="verifyUser(${user.id})" title="Verify User">
                                            <i class="fas fa-check"></i>
                                        </button>` : ''
                                    }
                                </td>
                            `;
                            tableBody.appendChild(row);
                        });
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="6" class="text-center text-danger">
                                    <i class="fas fa-exclamation-circle"></i> Error loading users: ${error.message}
                                </td>
                            </tr>
                        `;
                    });
            }

            // Add event listeners for filters
            document.getElementById('userSearch').addEventListener('input', debounce(fetchUsers, 300));
            document.getElementById('statusVerified').addEventListener('change', fetchUsers);
            document.getElementById('statusUnverified').addEventListener('change', fetchUsers);
            document.getElementById('typeLandlord').addEventListener('change', fetchUsers);
            document.getElementById('typeTenant').addEventListener('change', fetchUsers);

            // Debounce function to prevent too many API calls
            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            function getBadgeClass(role) {
                switch(role) {
                    case 'TENANT':
                        return 'bg-info';
                    case 'LANDLORD':
                        return 'bg-success';
                    case 'ADMINISTRATOR':
                        return 'bg-primary';
                    default:
                        return 'bg-secondary';
                }
            }

            function viewUser(userId) {
                fetch(`/api/administrators/users/${userId}/details`)
                    .then(response => response.json())
                    .then(user => {
                        // Create modal if it doesn't exist
                        let modalHtml = `
                            <div class="modal fade" id="userDetailsModal" tabindex="-1">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">User Details</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <h6>Basic Information</h6>
                                                    <table class="table">
                                                        <tr>
                                                            <th>Username:</th>
                                                            <td>${user.username || 'N/A'}</td>
                                                        </tr>
                                                        <tr>
                                                            <th>Full Name:</th>
                                                            <td>${user.firstName || ''} ${user.lastName || ''}</td>
                                                        </tr>
                                                        <tr>
                                                            <th>Email:</th>
                                                            <td>${user.email || 'N/A'}</td>
                                                        </tr>
                                                        <tr>
                                                            <th>Role:</th>
                                                            <td>${user.roles ? user.roles.join(', ') : 'N/A'}</td>
                                                        </tr>
                                                    </table>
                                                </div>
                                                ${user.monthlyIncome ? `
                                                <div class="col-md-6">
                                                    <h6>Tenant Information</h6>
                                                    <table class="table">
                                                        <tr>
                                                            <th>Monthly Income:</th>
                                                            <td>€${user.monthlyIncome}</td>
                                                        </tr>
                                                        <tr>
                                                            <th>Employment Status:</th>
                                                            <td>${user.employmentStatus || 'N/A'}</td>
                                                        </tr>
                                                    </table>
                                                    <div class="mt-3">
                                                        <h6>ID Documents</h6>
                                                        <div class="row">
                                                            <div class="col-md-6 mb-3">
                                                                <label>Front ID</label><br>
                                                                <img src="/images/loading.gif" class="img-fluid" id="frontId" style="max-height: 200px">
                                                            </div>
                                                            <div class="col-md-6 mb-3">
                                                                <label>Back ID</label><br>
                                                                <img src="/images/loading.gif" class="img-fluid" id="backId" style="max-height: 200px">
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>` : ''}
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;

                        // Remove existing modal if any
                        let existingModal = document.getElementById('userDetailsModal');
                        if (existingModal) {
                            existingModal.remove();
                        }

                        // Add new modal to body
                        document.body.insertAdjacentHTML('beforeend', modalHtml);

                        // Show modal
                        let modal = new bootstrap.Modal(document.getElementById('userDetailsModal'));
                        modal.show();

                        // Load ID images if tenant
                        if (user.monthlyIncome && (user.idPhotoFront || user.idPhotoBack)) {
                            setTimeout(() => {
                                if (user.idPhotoFront) {
                                    document.getElementById('frontId').src = `data:image/jpeg;base64,${user.idPhotoFront}`;
                                }
                            }, 500);

                            setTimeout(() => {
                                if (user.idPhotoBack) {
                                    document.getElementById('backId').src = `data:image/jpeg;base64,${user.idPhotoBack}`;
                                }
                            }, 1000);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Failed to load user details'
                        });
                    });
            }

            async function approveProperty(propertyId) {
                const result = await Swal.fire({
                    title: 'Verification Confirmation',
                    text: 'Are you sure you want to verify this property?',
                    showCancelButton: true,
                    confirmButtonText: '<i class="fas fa-check"></i> Verify',
                    cancelButtonText: '<i class="fas fa-times"></i> Cancel',
                    confirmButtonColor: '#28a745',
                    cancelButtonColor: '#6c757d'
                });

                if (result.isConfirmed) {
                    try {
                        console.log('Making API call to approve property'); // Debug log
                        const response = await fetch(`/api/administrators/properties/${propertyId}/approve`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });

                        console.log('API response status:', response.status); // Debug log

                        if (response.ok) {
                            Swal.fire(
                                'Verified!',
                                'Property verified successfully',
                                'success'
                            );
                            fetchProperties();
                        } else {
                            const errorData = await response.text();
                            console.error('API error:', errorData); // Debug log
                            Swal.fire(
                                'Error!',
                                `Failed to verify property: ${errorData}`,
                                'error'
                            );
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        Swal.fire(
                            'Error!',
                            'An error occurred while verifying the property',
                            'error'
                        );
                    }
                } else {
                    console.log('Verification cancelled by user'); // Debug log
                }
            }

            function fetchProperties() {
                console.log('Fetching properties...');
                const tableBody = document.getElementById('propertiesTableBody');
                
                // Get filter values
                const ownerSearch = document.getElementById('ownerSearch').value;
                const rentedChecked = document.getElementById('statusRented').checked;
                const unrentedChecked = document.getElementById('statusUnrented').checked;
                
                // Show loading state
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </td>
                    </tr>
                `;

                // Build query parameters
                const params = new URLSearchParams();
                if (ownerSearch) {
                    params.append('ownerUsername', ownerSearch);
                }
                
                // Handle rented status filter
                if (rentedChecked && !unrentedChecked) {
                    params.append('isRented', true);
                } else if (unrentedChecked && !rentedChecked) {
                    params.append('isRented', false);
                }
                
                fetch(`/api/administrators/properties?${params.toString()}`)
                    .then(response => response.json())
                    .then(properties => {
                        console.log('Received properties:', properties);
                        tableBody.innerHTML = '';
                        
                        properties.forEach(property => {
                            const ownerName = property.owner ? 
                                `${property.owner.firstName} ${property.owner.lastName} (${property.owner.username})` : 
                                'Unknown';
                            
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${property.propertyId || ''}</td>
                                <td>${property.address || ''}, ${property.city || ''}</td>
                                <td>${ownerName}</td>
                                <td>${property.type || ''}</td>
                                <td>€${property.rentAmount || '0'}</td>
                                <td>
                                    <span class="badge ${getBadgeClassForProperty(property.rented)}">
                                        ${property.rented ? 'Rented' : 'Available'}
                                    </span>
                                    <span class="badge ${property.approved ? 'bg-success' : 'bg-warning'}">
                                        ${property.approved ? 'Approved' : 'Pending'}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewProperty(${property.propertyId})" title="View Property">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger ms-1" onclick="deleteProperty(${property.propertyId})" title="Delete Property">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    ${!property.approved ? 
                                        `<button class="btn btn-sm btn-outline-success ms-1" onclick="approveProperty(${property.propertyId})" title="Approve Property">
                                            <i class="fas fa-check"></i>
                                        </button>` : ''
                                    }
                                </td>
                            `;
                            tableBody.appendChild(row);
                        });
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="8" class="text-center text-danger">
                                    <i class="fas fa-exclamation-circle"></i> Error loading properties: ${error.message}
                                </td>
                            </tr>
                        `;
                    });
            }

            // Add event listeners for property filters
            document.getElementById('ownerSearch').addEventListener('input', debounce(fetchProperties, 300));
            document.getElementById('statusRented').addEventListener('change', fetchProperties);
            document.getElementById('statusUnrented').addEventListener('change', fetchProperties);

            function getBadgeClassForProperty(isRented) {
                return isRented ? 'bg-success' : 'bg-warning';
            }

            function viewProperty(propertyId) {
                window.location.href = `/property/${propertyId}/details`;
            }

            function deleteUser(userId) {
                Swal.fire({
                    title: 'Are you sure?',
                    text: "This will permanently delete this user and all their associated data!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Yes, delete it!',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch(`/api/administrators/users/${userId}`, {
                            method: 'DELETE',
                            headers: {
                                'Accept': 'application/json'
                            }
                        })
                        .then(async response => {
                            const data = await response.json();
                            if (!response.ok) {
                                throw new Error(data.message || 'Failed to delete user');
                            }
                            return data;
                        })
                        .then(data => {
                            Swal.fire({
                                icon: 'success',
                                title: 'Deleted!',
                                text: data.message || 'User has been deleted successfully.',
                                timer: 2000
                            });
                            fetchUsers(); // Refresh the users list
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: error.message || 'Failed to delete user. Please try again.'
                            });
                        });
                    }
                });
            }

            function verifyUser(userId) {
                Swal.fire({
                    title: 'Verify User',
                    text: "Are you sure you want to verify this user?",
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#28a745',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Yes, verify!',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Show loading state
                        Swal.fire({
                            title: 'Verifying...',
                            text: 'Please wait while we verify the user.',
                            allowOutsideClick: false,
                            allowEscapeKey: false,
                            showConfirmButton: false,
                            willOpen: () => {
                                Swal.showLoading();
                            }
                        });

                        fetch(`/api/administrators/users/${userId}/verify`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            }
                        })
                        .then(async response => {
                            const text = await response.text();
                            if (!response.ok) {
                                throw new Error(text || 'Network response was not ok');
                            }
                            return text;
                        })
                        .then(message => {
                            Swal.fire({
                                icon: 'success',
                                title: 'Verified!',
                                text: message || 'User has been verified successfully.',
                                timer: 2000
                            });
                            fetchUsers(); // Refresh the users list
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: error.message || 'Failed to verify user. Please try again.'
                            });
                        });
                    }
                });
            }

            function deleteProperty(propertyId) {
                Swal.fire({
                    title: 'Are you sure?',
                    text: "This will permanently delete this property and all its associated data!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Yes, delete it!',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch(`/api/administrators/properties/${propertyId}`, {
                            method: 'DELETE'
                        })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.text();
                        })
                        .then(message => {
                            Swal.fire(
                                'Deleted!',
                                'Property has been deleted successfully.',
                                'success'
                            );
                            fetchProperties(); // Refresh the properties list
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            Swal.fire(
                                'Error!',
                                'Failed to delete property. Please try again.',
                                'error'
                            );
                        });
                    }
                });
            }

            function approveProperty(propertyId) {
                Swal.fire({
                    title: 'Approve Property',
                    text: "Are you sure you want to approve this property?",
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#28a745',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Yes, approve!',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch(`/api/administrators/properties/${propertyId}/approve`, {
                            method: 'POST'
                        })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.text();
                        })
                        .then(message => {
                            Swal.fire(
                                'Approved!',
                                'Property has been approved successfully.',
                                'success'
                            );
                            fetchProperties(); // Refresh the properties list
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            Swal.fire(
                                'Error!',
                                'Failed to approve property. Please try again.',
                                'error'
                            );
                        });
                    }
                });
            }

            async function viewReport(reportId) {
                try {
                    const response = await fetch(`/api/reports/details/${reportId}`);
                    if (!response.ok) throw new Error('Failed to fetch report details');
                    const report = await response.json();

                    // Show report details using SweetAlert2
                    await Swal.fire({
                        title: 'Report Details',
                        html: `
                            <div class="text-start">
                                <div class="mb-3">
                                    <strong>Title:</strong>
                                    <div class="mt-1">${report.title}</div>
                                </div>
                                <div class="mb-3">
                                    <strong>Description:</strong>
                                    <div class="mt-1">${report.description}</div>
                                </div>
                                <div class="mb-3">
                                    <strong>Reported By:</strong>
                                    <div class="mt-1">${report.user.username}</div>
                                </div>
                                <div class="mb-3">
                                    <strong>User Role:</strong>
                                    <div class="mt-1">${report.userRole}</div>
                                </div>
                                <div class="mb-3">
                                    <strong>Date Submitted:</strong>
                                    <div class="mt-1">${new Date(report.createDate).toLocaleString()}</div>
                                </div>
                                <div class="mb-3">
                                    <strong>Status:</strong>
                                    <div class="mt-1">${report.resolved ? 'Resolved' : 'Unresolved'}</div>
                                </div>
                            </div>
                        `,
                        width: '600px',
                        showCloseButton: true,
                        showConfirmButton: false
                    });
                } catch (error) {
                    console.error('Error viewing report:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: error.message || 'Failed to view report details'
                    });
                }
            }

            function loadReports() {
                const resolvedChecked = document.getElementById('resolvedFilter').checked;
                const unresolvedChecked = document.getElementById('unresolvedFilter').checked;

                fetch('/api/reports/all')
                    .then(response => response.json())
                    .then(reports => {
                        const filteredReports = reports.filter(report => 
                            (report.resolved && resolvedChecked) || (!report.resolved && unresolvedChecked)
                        );

                        const tableBody = document.getElementById('reportsTableBody');
                        tableBody.innerHTML = '';

                        filteredReports.forEach(report => {
                            const row = document.createElement('tr');
                            const createDate = new Date(report.createDate).toLocaleString();
                            row.innerHTML = `
                                <td>${report.id}</td>
                                <td>${report.user.username}</td>
                                <td>${report.userRole}</td>
                                <td>${report.title}</td>
                                <td>${createDate}</td>
                                <td>
                                    <button class="btn btn-sm btn-info" onclick="viewReport(${report.id})">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteReport(${report.id})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    <button class="btn btn-sm ${report.resolved ? 'btn-success' : 'btn-warning'}" 
                                            onclick="toggleReportStatus(${report.id})">
                                        ${report.resolved ? 'Resolved' : 'Pending'}
                                    </button>
                                </td>
                            `;
                            tableBody.appendChild(row);
                        });
                    })
                    .catch(error => {
                        console.error('Error loading reports:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Failed to load reports'
                        });
                    });
            }

            function deleteReport(reportId) {
                Swal.fire({
                    title: 'Are you sure?',
                    text: "This action cannot be undone!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Yes, delete it!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch(`/api/reports/${reportId}`, {
                            method: 'DELETE'
                        })
                        .then(response => {
                            if (response.ok) {
                                Swal.fire(
                                    'Deleted!',
                                    'Report deleted successfully',
                                    'success'
                                );
                                loadReports();
                            } else {
                                throw new Error('Failed to delete report');
                            }
                        })
                        .catch(error => {
                            console.error('Error deleting report:', error);
                            Swal.fire(
                                'Error!',
                                'Failed to delete report. Please try again.',
                                'error'
                            );
                        });
                    }
                });
            }

            function toggleReportStatus(reportId) {
                fetch(`/api/reports/${reportId}/toggle-status`, {
                    method: 'PUT'
                })
                .then(response => {
                    if (response.ok) {
                        loadReports();
                    } else {
                        throw new Error('Failed to update report status');
                    }
                })
                .catch(error => {
                    console.error('Error updating report status:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Failed to update report status. Please try again.'
                    });
                });
            }

            // Add event listeners for report filters
            document.getElementById('resolvedFilter').addEventListener('change', loadReports);
            document.getElementById('unresolvedFilter').addEventListener('change', loadReports);

            function showAlert(type, message) {
                // Remove any existing alerts
                const existingAlerts = document.querySelectorAll('.alert');
                existingAlerts.forEach(alert => alert.remove());

                // Create new alert
                const alert = document.createElement('div');
                alert.className = `alert alert-${type} alert-dismissible fade show`;
                alert.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                
                // Insert alert after the content header
                const contentHeader = document.querySelector('.content-header');
                contentHeader.insertAdjacentElement('afterend', alert);
                
                // Remove alert after 3 seconds
                setTimeout(() => {
                    alert.remove();
                }, 3000);
            }

            // Add event listener for owner search
            document.getElementById('ownerSearch').addEventListener('input', function() {
                fetchProperties();
            });

            // Initialize dashboard when the page loads
            document.addEventListener('DOMContentLoaded', function() {
                console.log('Page loaded, initializing dashboard...');
                updateDashboard();
                
                // Add event listeners for view type changes
                document.querySelectorAll('input[name="viewType"]').forEach(radio => {
                    radio.addEventListener('change', updateDashboard);
                });
            });
        </script>
    </th:block>
</body>
</html>
