<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <title>Landlord Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="/css/dashboard.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div th:fragment="content">
        <div class="container-fluid dashboard-content">
            <!-- Toggle Buttons and Add Property -->
            <div class="row mb-4">
                <div class="col-3"></div>
                <div class="col-6 text-center">
                    <div class="btn-group" role="group">
                        <input type="radio" class="btn-check" name="viewType" id="alertsView" checked>
                        <label class="btn btn-outline-primary" for="alertsView">
                            <i class="fas fa-bell"></i> Alerts
                        </label>
                        
                        <input type="radio" class="btn-check" name="viewType" id="propertiesView">
                        <label class="btn btn-outline-primary" for="propertiesView">
                            <i class="fas fa-building"></i> Properties
                        </label>
                    </div>
                </div>
                <div class="col-3 text-end">
                    <button class="btn btn-outline-primary hover-primary" data-bs-toggle="modal" data-bs-target="#addPropertyModal">
                        <i class="fas fa-plus"></i> Add Property
                    </button>
                </div>
            </div>

            <div class="row">
                <!-- Left Sidebar with Filters -->
                <div class="col-xl-3">
                    <div class="filter-card">
                        <div class="filter-header">
                            <h4><i class="fas fa-filter"></i> Filters</h4>
                        </div>
                        
                        <!-- Filter Toggle Buttons -->
                        <div class="filter-section" id="alertsFilterSection">
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="filterType" id="all" checked>
                                <label class="btn btn-outline-primary" for="all">
                                    <i class="fas fa-th-list"></i> All
                                </label>
                                
                                <input type="radio" class="btn-check" name="filterType" id="applications">
                                <label class="btn btn-outline-primary" for="applications">
                                    <i class="fas fa-file-alt"></i> Applications
                                </label>
                                
                                <input type="radio" class="btn-check" name="filterType" id="visits">
                                <label class="btn btn-outline-primary" for="visits">
                                    <i class="fas fa-calendar-check"></i> Visits
                                </label>
                            </div>
                        </div>

                        <!-- Property Status Filter -->
                        <div class="filter-section" id="propertyStatusFilter" style="display: none;">
                            <h5 class="filter-title">Property Status</h5>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="RENTED" id="statusRented">
                                <label class="form-check-label status-label rented" for="statusRented">
                                    <i class="fas fa-home"></i> RENTED
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="UNRENTED" id="statusUnrented">
                                <label class="form-check-label status-label unrented" for="statusUnrented">
                                    <i class="fas fa-house-damage"></i> UNRENTED
                                </label>
                            </div>
                        </div>

                        <!-- Application Status Filter -->
                        <div class="filter-section" id="applicationStatusFilter">
                            <h5 class="filter-title">Application Status</h5>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="PENDING" id="statusPending">
                                <label class="form-check-label status-label pending" for="statusPending">
                                    <i class="fas fa-clock"></i> PENDING
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="APPROVED" id="statusApproved">
                                <label class="form-check-label status-label approved" for="statusApproved">
                                    <i class="fas fa-check-circle"></i> APPROVED
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="REJECTED" id="statusRejected">
                                <label class="form-check-label status-label rejected" for="statusRejected">
                                    <i class="fas fa-times-circle"></i> REJECTED
                                </label>
                            </div>
                        </div>

                        <!-- Visit Status Filter -->
                        <div class="filter-section" id="visitStatusFilter">
                            <h5 class="filter-title">Visit Status</h5>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="REQUESTED" id="visitRequested">
                                <label class="form-check-label status-label requested" for="visitRequested">
                                    <i class="fas fa-question-circle"></i> REQUESTED
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="SCHEDULED" id="visitScheduled">
                                <label class="form-check-label status-label scheduled" for="visitScheduled">
                                    <i class="fas fa-calendar-alt"></i> SCHEDULED
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="CANCELED" id="visitCanceled">
                                <label class="form-check-label status-label canceled" for="visitCanceled">
                                    <i class="fas fa-ban"></i> CANCELED
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="COMPLETED" id="visitCompleted">
                                <label class="form-check-label status-label completed" for="visitCompleted">
                                    <i class="fas fa-check-double"></i> COMPLETED
                                </label>
                            </div>
                        </div>

                        <!-- Date Range Filter -->
                        <div class="filter-section">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="filter-title mb-0">Date Range</h5>
                                <button class="btn btn-sm btn-link text-danger" id="clearDates">
                                    <i class="fas fa-times"></i> Clear
                                </button>
                            </div>
                            <div class="mt-3">
                                <div class="mb-3">
                                    <label class="form-label">From</label>
                                    <div class="input-group date-input-group">
                                        <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                                        <input type="date" class="form-control custom-date-input" id="dateFrom">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">To</label>
                                    <div class="input-group date-input-group">
                                        <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                                        <input type="date" class="form-control custom-date-input" id="dateTo">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Content Area -->
                <div class="col-xl-9">
                    <div class="content-card">
                        <div class="content-header">
                            <h2><i class="fas fa-home"></i> Landlord Dashboard</h2>
                            <div class="header-actions">
                                <button class="btn btn-outline-light" onclick="refreshDashboard()">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                        </div>
                        <div id="dashboardContent" class="p-4">
                            <!-- Content will be loaded dynamically -->
                            <div class="loading-spinner">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Property Modal -->
        <div class="modal fade" id="addPropertyModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="fas fa-plus-circle"></i> Add New Property</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="addPropertyForm">
                            <div class="row mb-3">
                                <div class="col-md-8">
                                    <label class="form-label">Address</label>
                                    <input type="text" class="form-control" name="address" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Country</label>
                                    <input type="text" class="form-control" name="country" required>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label">Property Type</label>
                                    <select class="form-select" name="type" required>
                                        <option value="APARTMENT">Apartment</option>
                                        <option value="HOUSE">House</option>
                                        <option value="STUDIO">Studio</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Rent Amount (€)</label>
                                    <input type="number" class="form-control" name="rentAmount" required>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label">Bedrooms</label>
                                    <input type="number" class="form-control" name="bedrooms" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Bathrooms</label>
                                    <input type="number" class="form-control" name="bathrooms" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" name="description" rows="3"></textarea>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" name="hasParking">
                                        <label class="form-check-label">Parking Available</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" name="hasGarden">
                                        <label class="form-check-label">Garden</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" name="hasBalcony">
                                        <label class="form-check-label">Balcony</label>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="submitProperty()">Add Property</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Property Modal -->
        <div class="modal fade" id="editPropertyModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="fas fa-edit"></i> Edit Property</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editPropertyForm">
                            <div class="row mb-3">
                                <div class="col-md-8">
                                    <label class="form-label">Address</label>
                                    <input type="text" class="form-control" name="address" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Country</label>
                                    <input type="text" class="form-control" name="country" required>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label">Property Type</label>
                                    <select class="form-select" name="type" required>
                                        <option value="APARTMENT">Apartment</option>
                                        <option value="HOUSE">House</option>
                                        <option value="STUDIO">Studio</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Rent Amount (€)</label>
                                    <input type="number" class="form-control" name="rentAmount" required>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label">Bedrooms</label>
                                    <input type="number" class="form-control" name="bedrooms" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Bathrooms</label>
                                    <input type="number" class="form-control" name="bathrooms" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" name="description" rows="3"></textarea>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" name="hasParking">
                                        <label class="form-check-label">Parking Available</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" name="hasGarden">
                                        <label class="form-check-label">Garden</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" name="hasBalcony">
                                        <label class="form-check-label">Balcony</label>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="updateProperty()">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Delete Property Confirmation Modal -->
        <div class="modal fade" id="deletePropertyModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="fas fa-trash"></i> Delete Property</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to delete this property? This action cannot be undone.</p>
                        <input type="hidden" id="deletePropertyId">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger" onclick="confirmDeleteProperty()">Delete</button>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
        </div>
    </div>

    <!-- Scripts Fragment -->
    <th:block th:fragment="scripts">
        <style>
            .property-card {
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                transition: transform 0.2s, box-shadow 0.2s;
                height: 100%;
            }

            .property-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            }

            .property-card .card-title {
                font-size: 1.1rem;
                font-weight: 600;
                margin-bottom: 1rem;
                color: #2c3e50;
            }

            .property-card .card-text {
                color: #666;
                font-size: 0.9rem;
                line-height: 1.8;
            }

            .property-card .card-text i {
                width: 20px;
                color: #3498db;
            }

            .property-status {
                display: inline-block;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 0.8rem;
                font-weight: 500;
                margin-top: 10px;
            }

            .property-status.approved {
                background-color: #e8f5e9;
                color: #2e7d32;
            }

            .property-status.pending {
                background-color: #fff3e0;
                color: #ef6c00;
            }

            .btn-outline-primary {
                border-color: #3498db;
                color: #3498db;
            }

            .btn-outline-primary:hover {
                background-color: #3498db;
                color: white;
            }

            .btn-outline-danger {
                border-color: #e74c3c;
                color: #e74c3c;
            }

            .btn-outline-danger:hover {
                background-color: #e74c3c;
                color: white;
            }

            .loading-spinner {
                display: flex;
                justify-content: center;
                align-items: center;
                min-height: 200px;
            }

            .btn.btn-outline-primary.hover-primary:hover {
                color: #fff;
                background-color: var(--bs-primary);
                border-color: var(--bs-primary);
            }
            
            .properties-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 20px;
            }
        </style>
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                // Initialize filters
                const filterButtons = document.querySelectorAll('input[name="filterType"]');
                const applicationFilter = document.getElementById('applicationStatusFilter');
                const visitFilter = document.getElementById('visitStatusFilter');

                // Function to check all checkboxes in a container
                function checkAllFilters(container) {
                    if (container) {
                        const checkboxes = container.querySelectorAll('input[type="checkbox"]');
                        checkboxes.forEach(checkbox => checkbox.checked = true);
                    }
                }

                // Initial setup - show and check all filters
                checkAllFilters(applicationFilter);
                checkAllFilters(visitFilter);

                // Filter type change handlers
                filterButtons.forEach(button => {
                    button.addEventListener('change', function() {
                        applicationFilter.style.display = 'none';
                        visitFilter.style.display = 'none';

                        if (this.id === 'applications') {
                            applicationFilter.style.display = 'block';
                        } else if (this.id === 'visits') {
                            visitFilter.style.display = 'block';
                        } else if (this.id === 'all') {
                            applicationFilter.style.display = 'block';
                            visitFilter.style.display = 'block';
                        }
                        updateDashboard();
                    });
                });

                // Initial dashboard load
                updateDashboard();
            });

            function updateDashboard() {
                // Show loading spinner
                document.querySelector('.loading-spinner').style.display = 'block';
                
                // Prepare filter data
                const filters = {
                    viewType: 'propertiesView',
                    propertyStatus: Array.from(document.querySelectorAll('#propertyStatusFilter input:checked'))
                        .map(cb => cb.value)
                };

                // Make API call to fetch dashboard data
                fetch('/api/landlords/dashboard', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(filters)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load dashboard data');
                    }
                    return response.json();
                })
                .then(data => {
                    // Hide loading spinner
                    document.querySelector('.loading-spinner').style.display = 'none';
                    
                    const dashboardContent = document.getElementById('dashboardContent');
                    
                    // Display properties
                    const properties = data.properties || [];
                    if (properties.length === 0) {
                        dashboardContent.innerHTML = `
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> You haven't added any properties yet.
                                Click the "Add Property" button to get started.
                            </div>
                        `;
                    } else {
                        let propertiesHtml = '<div class="row">';
                        properties.forEach(property => {
                            const statusBadges = property.statuses.map(status => 
                                `<span class="badge bg-${status === 'COMPLETED' ? 'success' : 'warning'} me-1">${status}</span>`
                            ).join('');
                            
                            propertiesHtml += `
                                <div class="col-md-4 mb-4">
                                    <div class="card property-card">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <h5 class="card-title">${property.address}</h5>
                                                <div>${statusBadges}</div>
                                            </div>
                                            <p class="card-text">
                                                <i class="fas fa-home"></i> ${property.type}<br>
                                                <i class="fas fa-euro-sign"></i> ${property.rentAmount}/month<br>
                                                <i class="fas fa-bed"></i> ${property.bedrooms} bedrooms<br>
                                                <i class="fas fa-bath"></i> ${property.bathrooms} bathrooms<br>
                                                <i class="fas fa-map-marker-alt"></i> ${property.country}
                                            </p>
                                            <div class="mt-3">
                                                <button class="btn btn-outline-primary btn-sm me-2" onclick="editProperty(${property.id})">
                                                    <i class="fas fa-edit"></i> Edit
                                                </button>
                                                <button class="btn btn-outline-danger btn-sm" onclick="deleteProperty(${property.id})">
                                                    <i class="fas fa-trash"></i> Delete
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        propertiesHtml += '</div>';
                        dashboardContent.innerHTML = propertiesHtml;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.querySelector('.loading-spinner').style.display = 'none';
                    document.getElementById('dashboardContent').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle"></i> Failed to load dashboard data. Please try again.
                        </div>
                    `;
                });
            }

            function submitProperty() {
                const form = document.getElementById('addPropertyForm');
                const formData = new FormData(form);
                const property = Object.fromEntries(formData.entries());
                
                // Convert checkbox values to boolean
                property.hasParking = formData.get('hasParking') === 'on';
                property.hasGarden = formData.get('hasGarden') === 'on';
                property.hasBalcony = formData.get('hasBalcony') === 'on';
                
                fetch('/api/property', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(property)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to add property');
                    }
                    return response.json();
                })
                .then(data => {
                    showAlert('success', 'Property added successfully!');
                    $('#addPropertyModal').modal('hide');
                    form.reset();
                    refreshDashboard();
                })
                .catch(error => {
                    showAlert('danger', 'Error adding property: ' + error.message);
                });
            }

            function editProperty(propertyId) {
                fetch(`/api/property/${propertyId}`)
                .then(response => response.json())
                .then(property => {
                    const form = document.getElementById('editPropertyForm');
                    
                    // Set form values
                    form.querySelector('[name="address"]').value = property.address;
                    form.querySelector('[name="country"]').value = property.country;
                    form.querySelector('[name="type"]').value = property.type;
                    form.querySelector('[name="rentAmount"]').value = property.rentAmount;
                    form.querySelector('[name="bedrooms"]').value = property.bedrooms;
                    form.querySelector('[name="bathrooms"]').value = property.bathrooms;
                    form.querySelector('[name="description"]').value = property.description;
                    
                    // Set checkbox values
                    form.querySelector('[name="hasParking"]').checked = property.hasParking;
                    form.querySelector('[name="hasGarden"]').checked = property.hasGarden;
                    form.querySelector('[name="hasBalcony"]').checked = property.hasBalcony;
                    
                    // Store property ID for update
                    form.dataset.propertyId = propertyId;
                    
                    $('#editPropertyModal').modal('show');
                })
                .catch(error => {
                    showAlert('danger', 'Error loading property details: ' + error.message);
                });
            }

            function updateProperty() {
                const form = document.getElementById('editPropertyForm');
                const formData = new FormData(form);
                const property = Object.fromEntries(formData.entries());
                const propertyId = form.dataset.propertyId;
                
                // Convert checkbox values to boolean
                property.hasParking = formData.get('hasParking') === 'on';
                property.hasGarden = formData.get('hasGarden') === 'on';
                property.hasBalcony = formData.get('hasBalcony') === 'on';
                
                fetch(`/api/property/${propertyId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(property)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to update property');
                    }
                    return response.json();
                })
                .then(data => {
                    showAlert('success', 'Property updated successfully!');
                    $('#editPropertyModal').modal('hide');
                    refreshDashboard();
                })
                .catch(error => {
                    showAlert('danger', 'Error updating property: ' + error.message);
                });
            }

            function deleteProperty(propertyId) {
                document.getElementById('deletePropertyId').value = propertyId;
                $('#deletePropertyModal').modal('show');
            }

            function confirmDeleteProperty() {
                const propertyId = document.getElementById('deletePropertyId').value;
                
                fetch(`/api/property/${propertyId}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to delete property');
                    }
                    showAlert('success', 'Property deleted successfully!');
                    $('#deletePropertyModal').modal('hide');
                    refreshDashboard();
                })
                .catch(error => {
                    showAlert('danger', 'Error deleting property: ' + error.message);
                });
            }

            function showAlert(type, message) {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
                alertDiv.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.container').firstChild);
                
                // Auto dismiss after 5 seconds
                setTimeout(() => {
                    alertDiv.remove();
                }, 5000);
            }

            function refreshDashboard() {
                location.reload();
            }
        </script>
    </th:block>
</body>
</html>
