<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Management - RentalApp</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .property-form {
            max-width: 800px;
            margin: 30px auto;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        .property-list {
            max-width: 1000px;
            margin: 30px auto;
        }
        .property-card {
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .amenity-badge {
            margin-right: 5px;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/home.html">RentalApp</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/property-management.html">My Properties</a>
                    </li>
                </ul>
                <button class="btn btn-outline-light" onclick="logout()">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="property-form">
            <h2 class="text-center mb-4">Add New Property</h2>
            <div id="error-message" class="alert alert-danger" style="display: none;"></div>
            <div id="success-message" class="alert alert-success" style="display: none;"></div>

            <form id="propertyForm" onsubmit="handlePropertySubmit(event)">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="address" class="form-label">Address</label>
                        <input type="text" class="form-control" id="address" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="type" class="form-label">Property Type</label>
                        <select class="form-select" id="type" required>
                            <option value="APARTMENT">Apartment</option>
                            <option value="HOUSE">House</option>
                            <option value="STUDIO">Studio</option>
                        </select>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="rentAmount" class="form-label">Monthly Rent (€)</label>
                        <input type="number" class="form-control" id="rentAmount" min="0" step="0.01" required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="bedrooms" class="form-label">Bedrooms</label>
                        <input type="number" class="form-control" id="bedrooms" min="0" required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="bathrooms" class="form-label">Bathrooms</label>
                        <input type="number" class="form-control" id="bathrooms" min="0" required>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Amenities</label>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="Parking" id="parking">
                                <label class="form-check-label" for="parking">Parking</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="Air Conditioning" id="ac">
                                <label class="form-check-label" for="ac">Air Conditioning</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="Elevator" id="elevator">
                                <label class="form-check-label" for="elevator">Elevator</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="Furnished" id="furnished">
                                <label class="form-check-label" for="furnished">Furnished</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="Pets Allowed" id="pets">
                                <label class="form-check-label" for="pets">Pets Allowed</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="Balcony" id="balcony">
                                <label class="form-check-label" for="balcony">Balcony</label>
                            </div>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary w-100">Add Property</button>
            </form>
        </div>

        <div class="property-list">
            <h2 class="text-center mb-4">My Properties</h2>
            <div id="propertiesList"></div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this property?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete()">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let propertiesToDelete = null;
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));

        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login.html';
                return;
            }
            loadProperties();
        });

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/login.html';
        }

        async function handlePropertySubmit(event) {
            event.preventDefault();
            
            const errorDiv = document.getElementById('error-message');
            const successDiv = document.getElementById('success-message');
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';

            // Get selected amenities
            const amenities = [];
            document.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                amenities.push(checkbox.value);
            });

            const propertyData = {
                address: document.getElementById('address').value,
                type: document.getElementById('type').value,
                rentAmount: parseFloat(document.getElementById('rentAmount').value),
                bedrooms: parseInt(document.getElementById('bedrooms').value),
                bathrooms: parseInt(document.getElementById('bathrooms').value),
                amenities: amenities
            };

            try {
                const response = await fetch('/api/properties', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(propertyData)
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error);
                }

                // Clear form
                document.getElementById('propertyForm').reset();
                
                // Show success message
                successDiv.textContent = 'Property added successfully!';
                successDiv.style.display = 'block';

                // Reload properties list
                loadProperties();

            } catch (error) {
                errorDiv.textContent = error.message || 'Failed to add property';
                errorDiv.style.display = 'block';
                console.error('Error:', error);
            }
        }

        async function loadProperties() {
            try {
                const response = await fetch('/api/properties', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load properties');
                }

                const properties = await response.json();
                displayProperties(properties);

            } catch (error) {
                console.error('Error loading properties:', error);
                const errorDiv = document.getElementById('error-message');
                errorDiv.textContent = 'Failed to load properties';
                errorDiv.style.display = 'block';
            }
        }

        function displayProperties(properties) {
            const propertiesList = document.getElementById('propertiesList');
            propertiesList.innerHTML = '';

            properties.forEach(property => {
                const card = document.createElement('div');
                card.className = 'card property-card';
                card.innerHTML = `
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h5 class="card-title">${property.address}</h5>
                                <p class="card-text">
                                    <strong>Type:</strong> ${property.type}<br>
                                    <strong>Rent:</strong> €${property.rentAmount}/month<br>
                                    <strong>Bedrooms:</strong> ${property.bedrooms} | 
                                    <strong>Bathrooms:</strong> ${property.bathrooms}<br>
                                    <strong>Status:</strong> ${property.approved ? 
                                        '<span class="text-success">Approved</span>' : 
                                        '<span class="text-warning">Pending Approval</span>'}
                                </p>
                                <div>
                                    ${property.amenities.map(amenity => 
                                        `<span class="badge bg-secondary amenity-badge">${amenity}</span>`
                                    ).join('')}
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-danger" onclick="deleteProperty(${property.propertyId})">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                propertiesList.appendChild(card);
            });
        }

        function deleteProperty(propertyId) {
            propertiesToDelete = propertyId;
            deleteModal.show();
        }

        async function confirmDelete() {
            if (!propertiesToDelete) return;

            try {
                const response = await fetch(`/api/properties/${propertiesToDelete}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to delete property');
                }

                // Reload properties list
                loadProperties();
                
                // Show success message
                const successDiv = document.getElementById('success-message');
                successDiv.textContent = 'Property deleted successfully!';
                successDiv.style.display = 'block';

            } catch (error) {
                console.error('Error:', error);
                const errorDiv = document.getElementById('error-message');
                errorDiv.textContent = 'Failed to delete property';
                errorDiv.style.display = 'block';
            } finally {
                deleteModal.hide();
                propertiesToDelete = null;
            }
        }
    </script>
</body>
</html>
